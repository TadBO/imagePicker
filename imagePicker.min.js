"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var imagePciker=function(){function t(e){_classCallCheck(this,t);try{if(!e.imgSrc||!Array.isArray(e.imgSrc))throw new Error("参数异常！")}catch(e){return console.log(e),!1}this.img=new Image,this.imgIsLoaded=!1,this.canvas=document.createElement("canvas"),this.width=e.width||"800",this.height=e.height||"600",this.canvas.width=e.width||"800",this.canvas.height=e.height||"600",this.el=e.el||"body",this.context=this.canvas.getContext("2d"),this.imgX=e.imgX||0,this.imgY=e.imgY||0,this.imageX=e.imgX||0,this.imageY=e.imgY||0,this.imgScale=1,this.differX=0,this.differy=0,this.isMove=!1,this.posX=0,this.posY=0,this.lineW=0,this.lineH=0,this.imgSrc=e.imgSrc,this.line=e.line||[],this.srcIndex=0,this.loop=e.loop||!0,this.showMoveBtn=e.showMoveBtn||!1,this.showTopBar=void 0===e.showTopBar||e.showTopBar,this.init()}return _createClass(t,[{key:"init",value:function(){this.show(),this.loadImg(this.imgSrc[0].src),this.event()}},{key:"loadImg",value:function(e){var t=this;this.img.onload=function(){t.imgIsLoaded=!0,t.drawImage()},this.img.src=e}},{key:"drawImage",value:function(){var e=this.img.width*this.imgScale<=10?10:this.img.width*this.imgScale,t=this.img.height*this.imgScale<=10?10:this.img.height*this.imgScale;this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.img,0,0,this.img.width,this.img.height,this.imgX,this.imgY,e,t),this.setPosition(),this.setLineColor(),this.context.strokeRect(this.imgX+this.posX*this.imgScale,this.imgY+this.posY*this.imgScale,this.lineW*this.imgScale,this.lineH*this.imgScale)}},{key:"event",value:function(e){function t(){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(){var n=this;this.canvas.onmousedown=function(e){e.stopPropagation(),n.canvas.style.cursor="move",n.differX=event.clientX-n.imgX-document.querySelector(n.el).offsetLeft,n.differY=event.clientY-n.imgY-document.querySelector(n.el).offsetTop,n.isMove=!0},this.canvas.onmousemove=function(e){if(e.stopPropagation(),n.isMove){if(n.differX>n.img.width*n.imgScale||n.differX<0)return!1;if(n.differY>n.img.height*n.imgScale)return!1;n.imgX=e.clientX-n.differX-document.querySelector(n.el).offsetLeft,n.imgY=e.clientY-n.differY-document.querySelector(n.el).offsetTop,n.drawImage()}},this.canvas.onmouseup=function(){n.canvas.style.cursor="default",n.isMove=!1},this.canvas.onmousewheel=this.canvas.onwheel=function(e){var t,i=n.windowToCanvas(e.clientX,e.clientY);t=e.wheelDelta?e.wheelDelta:-40*e.deltalY,n.imgY=0<t?(n.imgScale*=2,n.imgX=2*n.imgX-i.x,2*n.imgY-i.y):(n.imgScale/=2,n.imgX=.5*n.imgX+.5*i.x,.5*n.imgY+.5*i.y),n.drawImage()}})},{key:"windowToCanvas",value:function(e,t){var i=this.canvas.getBoundingClientRect();return{x:e-i.left-(i.width-this.canvas.width)/2,y:t-i.top-(i.height-this.canvas.height)/2}}},{key:"setPosition",value:function(){for(var e=0,t=this.line.length;e<t;e++){if(-1!==this.img.src.indexOf(this.line[e].flag))return this.posX=this.line[e].posX,this.posY=this.line[e].posY,this.lineW=this.line[e].lineW,this.lineH=this.line[e].lineH,!1;this.posX=0,this.posY=0,this.lineW=0,this.lineH=0}}},{key:"setLineColor",value:function(){var t=this;this.line.forEach(function(e){if(-1!==t.img.src.indexOf(e.flag))switch(e.state){case 0:t.context.strokeStyle="red";break;case 1:t.context.strokeStyle="green";break;default:t.context.strokeStyle="#000"}})}},{key:"show",value:function(){var e=document.createElement("div");e.style.width=this.width+"px",e.style.height=this.height+"px",e.style.border="1px solid #eee",e.style.position="relative",this.showMoveBtn&&e.appendChild(this.moveBtn()),this.showTopBar&&(this.canvas.style.paddingTop="30px",e.appendChild(this.topBar())),e.appendChild(this.canvas),document.querySelector(this.el).appendChild(e)}},{key:"moveBtn",value:function(){var i=this,e=document.createElement("ul");e.style.position="absolute",e.style.listStyle="none",e.style.top="50%",e.style.transform="translateY(-50%)",e.style.right=0;var t=document.createElement("li");t.style.width="52px",t.style.height="52px",t.style.lineHeight="52px",t.style.textAlign="center",t.innerText="上一张",t.style.backgroundColor="rgba(0,0,0,.4)",t.style.color="#fff",t.style.cursor="pointer";var n=document.createElement("li");n.style.width="52px",n.style.height="52px",n.style.lineHeight="52px",n.style.textAlign="center",n.style.backgroundColor="rgba(0,0,0,.4)",n.style.color="#fff",n.style.borderBottom="1px solid #ddd",n.style.borderTop="1px solid #ddd",n.innerHTML=this.srcIndex+1+" / "+this.imgSrc.length,n.setAttribute("id","li_now");var s=document.createElement("li");return s.style.width="52px",s.style.height="52px",s.style.lineHeight="52px",s.style.textAlign="center",s.style.backgroundColor="rgba(0,0,0,.4)",s.style.color="#fff",s.innerHTML="下一张",s.style.cursor="pointer",e.appendChild(t),e.appendChild(n),e.appendChild(s),t.addEventListener("click",function(){if(i.srcIndex--,i.loop)i.srcIndex<0&&(i.srcIndex=i.imgSrc.length-1);else if(i.srcIndex<0)return!1;i.loadImg(i.imgSrc[i.srcIndex].src),n.innerHTML=i.srcIndex+1+" / "+i.imgSrc.length,i.showTopBar&&document.querySelector("#top-bar").childNodes.forEach(function(e,t){e.style.background="transparent",t===i.srcIndex&&(e.style.background="#1e90ff")}),i.imgX=0,i.imgY=0,i.imgScale=1,i.drawImage()}),s.addEventListener("click",function(){if(i.srcIndex++,i.loop)i.srcIndex>=i.imgSrc.length&&(i.srcIndex=0);else if(i.srcIndex>=i.imgSrc.length)return!1;i.loadImg(i.imgSrc[i.srcIndex].src),n.innerHTML=i.srcIndex+1+" / "+i.imgSrc.length,document.querySelector("#top-bar").childNodes.forEach(function(e,t){e.style.background="transparent",t===i.srcIndex&&(e.style.background="#1e90ff")}),i.imgX=i.imageX,i.imgY=i.imageY,i.imgScale=1,i.drawImage()}),e}},{key:"topBar",value:function(){var t=this,n=document.createElement("div");return n.setAttribute("id","top-bar"),n.style.position="absolute",n.style.height="30px",n.style.lineHeight="30px",n.style.width="100%",n.style.color="#fff",n.style.background="rgba(0, 0, 0 , .4)",n.style.top=0,n.style.left=0,this.imgSrc.forEach(function(e,t){var i=document.createElement("span");i.innerHTML=e.title,i.style.display="inline-block",i.style.padding="0 10px",i.style.cursor="pointer",0===t&&(i.style.background="#1e90ff"),i.setAttribute("data-index",t),n.appendChild(i)}),n.onclick=function(e){n.childNodes.forEach(function(e){e.style.background="transparent"}),e.target.getAttribute("data-index")&&(e.target.style.background="#1e90ff",t.srcIndex=Number(e.target.getAttribute("data-index")),t.showMoveBtn&&(document.querySelector("#li_now").innerHTML=t.srcIndex+1+" / "+t.imgSrc.length),t.loadImg(t.imgSrc[t.srcIndex].src),t.line.forEach(function(e){-1!==t.imgSrc[t.srcIndex].src.indexOf(e.flag)&&(t.imgX=-e.posX,t.imgY=-e.posY)}),t.imgScale=1,t.drawImage())},n}},{key:"selected",value:function(s){var n=this;try{if(s.length>this.imgSrc.length)throw new Error("参数异常！")}catch(e){return console.log(e),!1}this.showTopBar&&this.imgSrc.forEach(function(i,n){document.querySelector("#top-bar").childNodes[n].style.color="#fff",s.forEach(function(e,t){-1!=i.src.indexOf(e.flag)&&(document.querySelector("#top-bar").childNodes[n].style.color="red")})});for(var e=function(i,e){var t=n.imgSrc[i];if(-1!==t.src.indexOf(s[0].flag))return n.loadImg(t.src),n.imgX=-s[0].posX,n.imgY=-s[0].posY,n.imgScale=1,n.line=s,n.drawImage(),n.srcIndex=i,n.showMoveBtn&&(document.querySelector("#li_now").innerHTML=n.srcIndex+1+" / "+n.imgSrc.length),n.showTopBar&&document.querySelector("#top-bar").childNodes.forEach(function(e,t){e.style.background="transparent",t===i&&(e.style.background="#1e90ff")}),{v:!1}},t=0,i=this.imgSrc.length;t<i;t++){var o=e(t);if("object"===(void 0===o?"undefined":_typeof(o)))return o.v}}}]),t}();